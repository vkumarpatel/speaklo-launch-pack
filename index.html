<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Speaklo Tala Demo — Fixed Mic Start/Stop</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/bodymovin/5.9.6/lottie.min.js"></script>
  <style>
    body{font-family:Inter,Arial;display:flex;align-items:center;justify-content:center;height:100vh;background:#f5fbff;margin:0}
    .card{width:360px;padding:18px;border-radius:18px;background:white;box-shadow:0 8px 30px rgba(10,31,68,0.08);text-align:center}
    #anim{width:220px;height:220px;margin:0 auto;position:relative}
    .mouth { position:absolute; left:50%; transform:translateX(-50%); bottom:80px; width:64px; height:16px; background:#0a1f44; border-radius:10px; transition:height .06s ease, transform .06s ease; }
    .controls{margin-top:14px;display:flex;gap:10px;justify-content:center}
    button{padding:10px 14px;border-radius:10px;border:none;background:#0a1f44;color:#fff;font-weight:700;cursor:pointer}
    .small{background:transparent;color:#0a1f44;border:2px solid #0a1f44}
    .note{font-size:12px;color:#556;text-align:center;margin-top:10px}
  </style>
</head>
<body>
  <div class="card">
    <div id="anim"></div>
    <div class="mouth" id="mouth"></div>
    <div class="controls">
      <button id="welcome">Play Welcome</button>
      <button id="startMic" class="small">Start Mic</button>
      <button id="stopMic" class="small">Stop Mic</button>
    </div>
    <p style="color:#0a1f44;font-weight:600;margin-top:12px">Speaklo — Tala (Energetic)</p>
    <div class="note">If the mic doesn't start, check browser microphone permission and that the page is served over HTTPS.</div>
  </div>

<script>
/* ---------- Lottie (you must provide speaklo_tala.json or change path) ---------- */
const LOTTIE_JSON = 'speaklo_tala.json';
const anim = lottie.loadAnimation({
  container: document.getElementById('anim'),
  renderer: 'svg',
  loop: true,
  autoplay: true,
  path: LOTTIE_JSON
});

/* ---------- TTS welcome ---------- */
document.getElementById('welcome').onclick = () => {
  const text = "Hi — I'm Tala, your Speaklo coach. Ready for three minutes of practice?";
  const u = new SpeechSynthesisUtterance(text);
  u.rate = 0.95; u.pitch = 1;
  const voices = speechSynthesis.getVoices();
  const en = voices.find(v => v.lang && v.lang.startsWith('en')) || voices[0];
  if (en) u.voice = en;
  speechSynthesis.cancel();
  speechSynthesis.speak(u);
};

/* ---------- Robust mic start/stop ---------- */
let audioCtx = null;
let analyser = null;
let sourceNode = null;
let micStream = null;
let rafId = null;
const mouth = document.getElementById('mouth');

async function createAudioContextIfNeeded() {
  if (!audioCtx || audioCtx.state === 'closed') {
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    console.log('AudioContext created', audioCtx);
  } else {
    // resume if suspended
    if (audioCtx.state === 'suspended') {
      try { await audioCtx.resume(); console.log('AudioContext resumed'); } catch(e){ console.warn(e); }
    }
  }
}

/* Start microphone and animate mouth */
async function startMic() {
  try {
    // If already running, ignore
    if (micStream) {
      console.log('Mic already started');
      return;
    }

    // Request microphone permission & stream
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    micStream = stream;

    // Create or resume AudioContext
    await createAudioContextIfNeeded();

    // Create source and analyser
    sourceNode = audioCtx.createMediaStreamSource(stream);
    analyser = audioCtx.createAnalyser();
    analyser.fftSize = 256;
    sourceNode.connect(analyser);

    const data = new Uint8Array(analyser.frequencyBinCount);

    // animation tick
    function tick() {
      if (!analyser) return;
      analyser.getByteFrequencyData(data);
      let sum = 0;
      for (let i=0;i<data.length;i++) sum += data[i]*data[i];
      const rms = Math.sqrt(sum / data.length);
      const h = Math.max(10, Math.min(56, 14 + (rms/3)));
      mouth.style.height = h + 'px';
      mouth.style.transform = `translateX(-50%) scaleX(${1 + Math.min(0.6, rms/220)})`;
      rafId = requestAnimationFrame(tick);
    }
    tick();

    console.log('Mic started');
  } catch (err) {
    console.error('Error starting mic:', err);
    micStream = null;
    // helpful UI message
    alert('Cannot access microphone. Please allow microphone permission and ensure the page is served over HTTPS.');
  }
}

/* Stop microphone and cleanup */
function stopMic() {
  try {
    // cancel RAF
    if (rafId) { cancelAnimationFrame(rafId); rafId = null; }

    // disconnect analyser/source
    if (analyser) {
      try { analyser.disconnect(); } catch(e){/*ignore*/ }
      analyser = null;
    }
    if (sourceNode) {
      try { sourceNode.disconnect(); } catch(e){/*ignore*/ }
      sourceNode = null;
    }

    // stop media tracks
    if (micStream) {
      micStream.getTracks().forEach(t => {
        try { t.stop(); } catch(e){/*ignore*/}
      });
      micStream = null;
    }

    // prefer to suspend rather than close for cross-browser stability
    if (audioCtx && audioCtx.state !== 'closed') {
      audioCtx.suspend().then(() => console.log('audioCtx suspended')).catch(()=>{});
      // do not close to avoid recreate issues on some browsers
    }

    // reset mouth to idle
    mouth.style.height = '16px';
    mouth.style.transform = 'translateX(-50%) scaleX(1)';

    console.log('Mic stopped & cleaned up');
  } catch (e) {
    console.warn('stopMic cleanup error', e);
  }
}

/* Buttons */
document.getElementById('startMic').onclick = startMic;
document.getElementById('stopMic').onclick = stopMic;

/* Extra: when page unload, make sure to stop everything */
window.addEventListener('beforeunload', () => {
  try { stopMic(); if (audioCtx && audioCtx.state !== 'closed') audioCtx.close(); } catch(e){}
});
</script>
</body>
</html>
